(window.webpackJsonp=window.webpackJsonp||[]).push([[17],{1034:function(e,t,n){"use strict";n.r(t),n.d(t,"default",(function(){return H}));var a=n(124),r=n.n(a),o=n(4),c=n.n(o),s=n(5),i=n.n(s),l=n(6),u=n.n(l),m=n(7),d=n.n(m),f=n(29),g=n.n(f),h=n(8),p=n.n(h),b=n(27),v=n.n(b),S=n(0),k=n.n(S),E=(n(97),n(638)),y=n(639),j=n(715),N=n(185),O=n(652),D=n(617),_=n.n(D),w=n(687),I=(n(23),n(714),n(713)),L=n(18),x=n(72),Y=(n(663),n(87),n(188)),T=n(698),R=n.n(T),C=n(712),P=n(16),G=n(898);function W(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function F(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?W(Object(n),!0).forEach((function(t){v()(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):W(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var H=function(e){function t(e){var n;return c()(this,t),n=u()(this,d()(t).call(this,e)),v()(g()(n),"loadData",(function(){return O.a.getSubjectListForRegistration()})),v()(g()(n),"onRegister",(function(e){var t=n.state,a=t.schedule,r=t.pickedSubject,o=t.subjectList;if(!a)return n.toggleRegister(e);var c=o.find((function(e){return e._id===r})).lessons.reduce((function(e,t){return e.concat(t.map((function(e){return e._id})))}),[]),s=a.list.map((function(e){return e._id})),i=null;return s.find((function(e){return!!c.includes(e)}))||!a.list.find((function(t){return!!e.find((function(e){return!(e.dayOfWeek!==t.dayOfWeek||e.from.name>t.to.name||e.to.name<t.from.name)&&(i={newItem:e,existed:t},!0)}))}))?n.toggleRegister(e):(console.log(i),Y.b.alert({text:k.a.createElement(j.a,{strongText:"Thông báo:",type:"border",color:"danger",content:k.a.createElement(k.a.Fragment,null,k.a.createElement("span",{className:"pl-3"},"Bạn không thể đăng ký ",k.a.createElement("strong",null,i.newItem.name)," do trùng vào ",k.a.createElement("strong",null,i.existed.dayOfWeek<7?"Thứ "+(i.existed.dayOfWeek+1):"Chủ nhật")," ",k.a.createElement("strong",null,"Ca ",i.existed.from.name,"-",i.existed.to.name)," của ",k.a.createElement("strong",null,i.existed.class.name)))}),title:"Lỗi đăng ký",btnText:"Đồng ý"}))})),v()(g()(n),"updateSubjectLessons",(function(e,t){for(var a=n.state.subjectList,r=0;r<a.length;r++){if(a[r]._id===e._id)return a[r].lessons=t,n.setState({subjectList:a})}})),v()(g()(n),"toggleRegister",(function(e){var t=L.a.getState().info,a=x.a.syncGet(),r=a.currentYear,o=a.currentSemester,c=n.state.subjectList.find((function(t){return t.lessons.find((function(t){return t.find((function(t){return t._id===e[0]._id}))}))}));return I.a.toggleRegisterLesson(t._id,"".concat(r.from,"-").concat(r.to),o,{socketID:n.socket.id,lesson:e,eventID:n.state.event._id,subject:c}).then((function(){return Promise.all([n.board.loadData(),O.a.getSubjectInfo(c.lessons,"".concat(r.from,"-").concat(r.to),o).then((function(e){n.updateSubjectLessons(c,e),n.setState({loading:!1})})).catch((function(e){n.setState({error:e,loading:!1})}))])})).catch((function(e){if("full"===e.message)return Y.b.alert({text:k.a.createElement(j.a,{strongText:"Thông báo:",type:"border",color:"danger",content:k.a.createElement(k.a.Fragment,null,k.a.createElement("span",{className:"pl-3"},"Bạn không thể đăng ký ",k.a.createElement("strong",null,e.extra.name)," do lớp đã đầy"))}),title:"Lỗi đăng ký",btnText:"Đồng ý"})}))})),v()(g()(n),"displayInsScheduleItem",(function(e){return k.a.createElement("div",{className:"common-inner-task"},k.a.createElement("div",{className:"class-name"},e.class.name),k.a.createElement("div",{className:"class-room-name"},e.classRoom.name))})),v()(g()(n),"onClickScheduleItem",(function(e,t){(0,t.setLoading)();var a=!0,r=!1,o=void 0;try{for(var c,s=n.state.subjectList[Symbol.iterator]();!(a=(c=s.next()).done);a=!0){var i=c.value.lessons.find((function(t){return!!t.find((function(t){return t._id===e._id}))}));if(i)return n.toggleRegister(i)}}catch(e){r=!0,o=e}finally{try{a||null==s.return||s.return()}finally{if(r)throw o}}})),n.init={event:null,subjectList:[],error:null,loading:!0,delayEvent:null,pickedSubject:null},n.state=F({},n.init,{schedule:null}),n.socket=null,n.socket=R()(document.location.origin+"/subject-registered"),n.socket.on("connect",(function(){n.socket.on("start-event",(function(e){e.parentID;var t=e.year,a=e.semester,r=e.studentGroup,o=e.event,c=L.a.getState().info,s=x.a.syncGet(),i=s.currentYear,l=s.currentSemester,u=s.latestSchoolYear;console.log(l===Number(a)),console.log(Number(t.from)===i.from),console.log(Number(t.to)===i.to),console.log(r===Object(P.c)(c.schoolYear,c.speciality.department,u)),console.log(o.appliedStudents.find((function(e){return e.toString()===c._id.toString()}))),l===Number(a)&&Number(t.from)===i.from&&Number(t.to)===i.to&&r===Object(P.c)(c.schoolYear,c.speciality.department,u)&&o.appliedStudents.find((function(e){return e.toString()===c._id.toString()}))&&(n.setState({loading:!0}),n.loadData().then((function(e){e.delayEvent||(n.socket.emit("join",e.event._id),n.board.loadData()),n.setState(F({},n.init,{},e,{loading:!1}))})).catch((function(e){n.setState(F({},n.init,{error:e,loading:!1}))})))})),n.socket.on("stop-event",(function(e){var t=e.parentID,a=(e.year,e.semester,e.studentGroup,e.event);console.log("zzz");var r=L.a.getState().info;console.log(t),n.state.event&&n.state.event._id===t&&a.appliedStudents.find((function(e){return e.toString()===r._id.toString()}))&&(n.socket.emit("unsubscribe",t),n.setState({loading:!0}),setTimeout((function(){n.loadData().then((function(e){n.setState(F({},n.init,{},e,{loading:!1}))})).catch((function(e){n.setState(F({},n.init,{error:e,loading:!1}))}))}),2e3))})),n.socket.on("update-subject-list",(function(e){var t=e.eventID,a=e.socketID,r=e.subject;if(n.state.event&&n.state.event._id===t&&n.socket.id!==a&&(console.log(r),n.state.subjectList&&n.state.subjectList.find((function(e){return e._id===r._id})))){var o=x.a.syncGet(),c=o.currentYear,s=o.currentSemester;O.a.getSubjectInfo(r.lessons,"".concat(c.from,"-").concat(c.to),s).then((function(e){n.setState({loading:!1}),n.updateSubjectLessons(r,e)})).catch((function(e){n.setState({error:e,loading:!1})}))}}))})),n.loadData().then((function(e){e.delayEvent||n.socket.emit("join",e.event._id),n.setState(F({},e,{loading:!1}))})).catch((function(e){n.setState({error:e,loading:!1})})),n}return p()(t,e),i()(t,[{key:"componentWillUnmount",value:function(){this.socket&&this.socket.disconnect()}},{key:"render",value:function(){var e=this,t=this.state,n=t.subjectList,a=t.error,o=t.loading,c=t.delayEvent,s=t.pickedSubject,i=n.find((function(e){return e._id===s}));console.log(a);var l=c||a?"Đăng ký học không khả dụng lúc này":"";return k.a.createElement(E.a,{title:"Đăng ký học"},k.a.createElement(y.a,{title:"Đăng ký học"},k.a.createElement("div",{className:"registration-route manage-list-route"},k.a.createElement("div",{className:"common-route-wrapper"},k.a.createElement("div",{className:"content-wrapper"},k.a.createElement("div",{className:"subject-list"},a?k.a.createElement(j.a,{icon:k.a.createElement("i",{className:"fas fa-info-circle"}),strongText:"Thông báo:",content:k.a.createElement(k.a.Fragment,null,k.a.createElement("span",{className:"pl-3"},a.message))}):o?k.a.createElement(N.a,null):c?k.a.createElement("div",{className:"registration-notify"},k.a.createElement("div",{className:"small-title"}," Thông báo thời gian đăng ký học"),k.a.createElement(j.a,{icon:k.a.createElement("i",{className:"far fa-clock"}),strongText:"Học kì ".concat(c.semester+1," Nhóm ").concat(c.studentGroup," Năm học ").concat(c.year.from,"-").concat(c.year.to,": "),color:"success",content:k.a.createElement(k.a.Fragment,null,k.a.createElement("span",{className:"pl-3"},"Từ ",k.a.createElement("strong",null,_()(c.activeChildEvent.from).format("HH:mm DD/MM/YYYY"))," đến ",k.a.createElement("strong",null,_()(c.activeChildEvent.to).format("HH:mm DD/MM/YYYY"))))})):k.a.createElement(k.a.Fragment,null,k.a.createElement("div",{className:"small-title"},"Danh sách môn đăng ký"),k.a.createElement(G.a,{pickedSubject:s,subjectList:n,subject:i,schedule:this.state.schedule,onRegister:this.onRegister,toggleRegister:this.toggleRegister,onChange:function(t){return e.setState({pickedSubject:t})}}))),k.a.createElement(C.a,{schoolYear:L.a.getState().info.schoolYear,schedule:this.state.schedule,label:"Học phí tạm tính"}),k.a.createElement("div",{className:"small-title"},"Thời khóa biểu tạm thời"),k.a.createElement(w.a,{ref:function(t){return e.board=t},className:"ins-schedule-board",api:function(){var t,n,a,o,c;return r.a.async((function(r){for(;;)switch(r.prev=r.next){case 0:return t=L.a.getState(),n=t.info,a=x.a.syncGet(),o=a.currentYear,c=a.currentSemester,r.abrupt("return",I.a.getStudentSchedule(n._id,"".concat(o.from,"-").concat(o.to),c).then((function(t){return e.setState({schedule:t}),t||{list:[]}})));case 3:case"end":return r.stop()}}))},displayItem:this.displayInsScheduleItem,onClickItem:this.onClickScheduleItem,getDayOfWeek:function(e){return e.dayOfWeek},getShiftStart:function(e){return e.from.name},getShiftEnd:function(e){return e.to.name},showSuggestion:!0,error:l}))))))}}]),t}(k.a.Component)}}]);